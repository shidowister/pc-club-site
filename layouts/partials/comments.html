<div class="giscus"></div>

<script>
    // -------------------------------------------------------------------
    // 1. 設定情報の定義
    // -------------------------------------------------------------------
    const giscusConfig = {
        repo: "shidowister/ist-md-pc-club-site",
        repoId: "R_kgDOQg0ojg",
        category: "General",
        categoryId: "DIC_kwDOQg0ojs4C0htG",
        mapping: "title",
        reactionsEnabled: "1",
        emitMetadata: "0",
        inputPosition: "bottom",
        lang: "ja",
    };

    // -------------------------------------------------------------------
    // 2. 現在のテーマを判定する関数（localStorage最優先）
    // -------------------------------------------------------------------
    function getCurrentTheme() {
        const localTheme = localStorage.getItem("pref-theme");
        
        // ローカルストレージに設定があればそれを使う
        if (localTheme === "dark") return "dark";
        if (localTheme === "light") return "light";
        
        // 設定がなければOSの設定を使う
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }

    // -------------------------------------------------------------------
    // 3. Giscusに命令を送る関数
    // -------------------------------------------------------------------
    function setGiscusTheme() {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;

        // 最新のテーマを取得
        const theme = getCurrentTheme();

        // Giscusに送信
        iframe.contentWindow.postMessage({
            giscus: {
                setConfig: {
                    theme: theme
                }
            }
        }, 'https://giscus.app');
        
        console.log(`[Giscus Debug] Theme update sent: ${theme}`);
    }

    // -------------------------------------------------------------------
    // 4. 初期ロード（Giscusの生成）
    // -------------------------------------------------------------------
    const initialTheme = getCurrentTheme();
    const giscusScript = document.createElement("script");
    giscusScript.src = "https://giscus.app/client.js";
    
    // 設定を展開
    Object.keys(giscusConfig).forEach(key => {
        giscusScript.setAttribute("data-" + key.replace(/([A-Z])/g, "-$1").toLowerCase(), giscusConfig[key]);
    });
    
    // 初期テーマをセット
    giscusScript.setAttribute("data-theme", initialTheme);
    giscusScript.crossOrigin = "anonymous";
    giscusScript.async = true;
    document.querySelector(".giscus").appendChild(giscusScript);
    
    console.log(`[Giscus Debug] Initial load with: ${initialTheme}`);

    // -------------------------------------------------------------------
    // 5. ボタン切り替え時の動作（少し待ってから実行）
    // -------------------------------------------------------------------
    const themeToggle = document.querySelector('#theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            // PaperModの処理が終わるのを300ms待つ（時間を少し伸ばしました）
            setTimeout(setGiscusTheme, 300);
        });
    }
</script>