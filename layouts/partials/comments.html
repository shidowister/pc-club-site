<div class="giscus"></div>

<script>
    // -------------------------------------------------------------------
    // 1. 現在のテーマ（Dark/Light）を判定する関数
    // -------------------------------------------------------------------
    function getTargetTheme() {
        // PaperModの保存された設定を取得
        const savedTheme = localStorage.getItem("pref-theme");

        // 設定があればそれに従う
        if (savedTheme === "dark") return "transparent_dark"; // ダーク時は背景透過
        if (savedTheme === "light") return "light";

        // 設定がないならOSの設定に従う
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "transparent_dark" : "light";
    }

    // -------------------------------------------------------------------
    // 2. Giscusを「生成」する関数
    //    (既存のものがあれば消して、新しく作り直す)
    // -------------------------------------------------------------------
    function loadGiscus() {
        const container = document.querySelector(".giscus");
        
        // ★ここがポイント：一度中身を空っぽにする（破壊）
        container.innerHTML = "";

        // 新しい設定でスクリプトを作る（再生）
        const giscusScript = document.createElement("script");
        const theme = getTargetTheme(); // その瞬間の正しいテーマを取得

        // 基本設定
        const config = {
            "src": "https://giscus.app/client.js",
            "data-repo": "shidowister/ist-md-pc-club-site",
            "data-repo-id": "R_kgDOQg0ojg",
            "data-category": "General",
            "data-category-id": "DIC_kwDOQg0ojs4C0htG",
            "data-mapping": "title",
            "data-strict": "0",
            "data-reactions-enabled": "1",
            "data-emit-metadata": "0",
            "data-input-position": "bottom",
            "data-lang": "ja",
            "data-theme": theme, // ★ここで最新のテーマをセット
            "crossorigin": "anonymous",
            "async": ""
        };

        // 属性を付与
        Object.keys(config).forEach(key => {
            giscusScript.setAttribute(key, config[key]);
        });

        // 箱に追加（これで表示される）
        container.appendChild(giscusScript);
        
        console.log(`[Giscus] Reloaded with theme: ${theme}`);
    }

    // -------------------------------------------------------------------
    // 3. 実行タイミングの設定
    // -------------------------------------------------------------------
    
    // ① ページを開いた時：即座にロード
    loadGiscus();

    // ② ボタンを押した時：Giscusをリロードさせる
    const themeToggle = document.querySelector('#theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            // PaperModがlocalstorageを書き換えるのを一瞬待つ
            setTimeout(loadGiscus, 200);
        });
    }
</script>