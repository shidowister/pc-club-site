<div class="giscus"></div>

<script>
    // -------------------------------------------------------------------
    // 1. 【初期表示用】 保存された設定から正しいテーマを取得する関数
    // -------------------------------------------------------------------
    function getInitialTheme() {
        const localTheme = localStorage.getItem("pref-theme");
        if (localTheme === "dark") return "dark";
        if (localTheme === "light") return "light";
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }

    // -------------------------------------------------------------------
    // 2. 【切り替え用】 Giscusに新しいテーマを通知する関数
    // -------------------------------------------------------------------
    function updateGiscusTheme() {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;

        // 現在の画面の状態（bodyタグのclass）を見て、darkかlightかを決める
        const theme = document.body.classList.contains('dark') ? 'dark' : 'light';

        // Giscusにメッセージを送信
        iframe.contentWindow.postMessage({
            giscus: {
                setConfig: {
                    theme: theme
                }
            }
        }, 'https://giscus.app');
    }

    // -------------------------------------------------------------------
    // 3. Giscus本体の読み込み（初期テーマをセットして開始）
    // -------------------------------------------------------------------
    const giscusConfig = {
        repo: "shidowister/ist-md-pc-club-site",
        repoId: "R_kgDOQg0ojg",
        category: "General",
        categoryId: "DIC_kwDOQg0ojs4C0htG",
        mapping: "title",
        reactionsEnabled: "1",
        emitMetadata: "0",
        inputPosition: "bottom",
        lang: "ja",
    };

    const giscusScript = document.createElement("script");
    giscusScript.src = "https://giscus.app/client.js";
    Object.keys(giscusConfig).forEach(key => {
        giscusScript.setAttribute("data-" + key.replace(/([A-Z])/g, "-$1").toLowerCase(), giscusConfig[key]);
    });
    // ★ここで初期テーマを適用（再読み込み時のズレ防止）
    giscusScript.setAttribute("data-theme", getInitialTheme());
    giscusScript.crossOrigin = "anonymous";
    giscusScript.async = true;
    document.querySelector(".giscus").appendChild(giscusScript);


    // -------------------------------------------------------------------
    // 4. テーマ変更の検知（ここを強化しました）
    // -------------------------------------------------------------------
    
    // 【作戦A】 画面のクラスが変わったら即座に更新を実行
    const observer = new MutationObserver(updateGiscusTheme);
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

    // 【作戦B】 テーマ切り替えボタン（#theme-toggle）がクリックされたら念押しで実行
    const themeToggle = document.querySelector("#theme-toggle");
    if (themeToggle) {
        themeToggle.addEventListener("click", function() {
            // クラスの切り替えが終わるのを一瞬待ってから実行
            setTimeout(updateGiscusTheme, 50);
        });
    }
</script>